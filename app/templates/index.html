{% extends "base.html" %}
{% block content %}
  <header class="p-3 border-b flex items-center justify-between">
    <h1 class="text-2xl font-semibold">Fork & Filter</h1>

    <!-- Segmented view switch -->
    <div class="inline-flex rounded-lg overflow-hidden border">
      <button class="px-3 py-2 text-sm bg-white hover:bg-gray-50" data-mode="filters" id="btn-filters">Filters</button>
      <button class="px-3 py-2 text-sm bg-white hover:bg-gray-50" data-mode="map" id="btn-map">Map</button>
      <button class="px-3 py-2 text-sm bg-white hover:bg-gray-50" data-mode="both" id="btn-both">Both</button>
    </div>
  </header>

  <div class="grid md:grid-cols-3 gap-4 p-3">
    <!-- LEFT: filters + map, shown per mode -->
    <main class="md:col-span-2 space-y-4">
      <!-- Filters pane -->
      <section id="filters-pane" class="transition-opacity duration-300">
        <form id="filters"
              class="space-y-3"
              hx-get="/search"
              hx-target="#results"
              hx-swap="outerHTML"
              hx-trigger="load, change delay:250ms">
          <input type="hidden" name="lat" id="lat" value="32.7767">
          <input type="hidden" name="lng" id="lng" value="-96.7970">

          <label class="block text-sm">Radius (km)
            <input class="border p-2 rounded w-full" type="number" step="0.1" name="radius_km" value="8">
          </label>

          <label class="block text-sm">Menu terms (comma-separated)
            <input class="border p-2 rounded w-full" type="text" name="terms" placeholder="shawarma,tacos">
          </label>

          <label class="block text-sm">Prices
            <select class="border p-2 rounded w-full" name="prices" multiple>
              <option value="1">$</option>
              <option value="2">$$</option>
              <option value="3">$$$</option>
            </select>
            <p class="text-xs opacity-70 mt-1">Hold Ctrl/Cmd to select multiple</p>
          </label>

          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="halal" value="true"> Halal only
          </label>

          <label class="block text-sm">Busyness
            <select class="border p-2 rounded w-full" name="busy" multiple>
              <option>Low</option><option>Moderate</option><option>High</option>
            </select>
          </label>

          <div class="flex items-center gap-2">
            <button type="button" id="use-location" class="px-3 py-2 bg-sky-600 text-white rounded">
              Use my location
            </button>
            <span id="loading" class="htmx-indicator text-sm opacity-70">Loading…</span>
          </div>
        </form>
      </section>

      <!-- Map pane -->
      <section id="map-pane" class="transition-opacity duration-300">
        <div id="map" class="h-[55vh] rounded border"></div>
      </section>
    </main>

    <!-- RIGHT: results panel -->
    <aside class="md:col-span-1">
      <div class="sticky top-3 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Results</h2>
          <!-- Single “Load more nearby” button -->
          <button
            type="button"
            class="px-3 py-2 rounded bg-emerald-600 text-white"
            hx-get="/search"
            hx-include="#filters"
            hx-vals='{"enrich":"1"}'
            hx-target="#results"
            hx-swap="outerHTML"
            hx-indicator="#loading">
            Load more nearby
          </button>
        </div>

        <div id="results" class="space-y-3 max-h-[70vh] overflow-y-auto border rounded p-2"></div>
      </div>
    </aside>
  </div>

  <script>
    // --- refs
    const latInput = document.getElementById('lat');
    const lngInput = document.getElementById('lng');
    const filtersPane = document.getElementById('filters-pane');
    const mapPane = document.getElementById('map-pane');
    const btnFilters = document.getElementById('btn-filters');
    const btnMap = document.getElementById('btn-map');
    const btnBoth = document.getElementById('btn-both');

    // default mode = BOTH (persisted)
    let mode = localStorage.getItem('ff_mode') || 'both';

    // --- geolocation button
    const useLocBtn = document.getElementById('use-location');
    if (useLocBtn) {
      useLocBtn.onclick = () => {
        if (!navigator.geolocation) return alert("Geolocation not supported");
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          latInput.value = latitude.toFixed(6);
          lngInput.value = longitude.toFixed(6);
          const r = Number(document.querySelector('[name="radius_km"]').value || 0);
          setUserLocation(latitude, longitude, r);
          document.getElementById('filters').dispatchEvent(new Event('change', { bubbles: true }));
          localStorage.setItem('ff_loc', JSON.stringify({ lat: latitude, lng: longitude }));
        }, () => alert("Couldn't get your location"));
      };
    }

    // restore last location
    const saved = localStorage.getItem('ff_loc');
    if (saved) {
      const { lat: la, lng: lo } = JSON.parse(saved);
      if (la && lo) { latInput.value = la; lngInput.value = lo; }
    }

    // --- Leaflet
    let map, pins = [], userMarker, radiusCircle;
    function initMapOnce() {
      if (map) return;
      map = L.map('map').setView([32.7767, -96.7970], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }
    function setUserLocation(lat, lng, radiusKm) {
      if (!map) return;
      userMarker?.remove();
      radiusCircle?.remove();

      userMarker = L.circleMarker([lat, lng], {
        radius: 7,
        color: '#000',
        weight: 2,
        fillColor: '#000',
        fillOpacity: 1
      }).addTo(map).bindTooltip('You are here');

      if (radiusKm && radiusKm > 0) {
        radiusCircle = L.circle([lat, lng], { radius: radiusKm * 1000 }).addTo(map);
      }
    }
    window.ff_all_points = window.ff_all_points || [];
    window.ff_marker_by_id = {};

    function renderMarkers(points){
      pins.forEach(m => m.remove()); pins = [];
      window.ff_marker_by_id = {};

      if (!points || !points.length) return;

      const layers = [];
      points.forEach(p => {
        const dollars = '$'.repeat(p.price || 0);
        const m = L.marker([p.lat, p.lng]).addTo(map)
          .bindPopup(`${p.name}<br>${p.distance_km} km | ${dollars} | ${p.busy}`);
        pins.push(m); layers.push(m);
        if (p.id != null) window.ff_marker_by_id[String(p.id)] = m;
      });

      if (userMarker) layers.push(userMarker);
      if (radiusCircle) layers.push(radiusCircle);

      const g = L.featureGroup(layers);
      map.fitBounds(g.getBounds().pad(0.2));
    }


    // --- HTMX: update markers after results load
    window.ff_all_points = [];

    document.body.addEventListener('htmx:afterSwap', (e) => {
      if (e.target.id !== 'results') return;

      const el = document.getElementById('markers-json');
      const page = parseInt(e.target.dataset.page || '1', 10);

      let newPoints = [];
      if (el) {
        try { newPoints = JSON.parse(el.textContent || '[]'); } catch {}
      }

      if (page <= 1) {
        window.ff_all_points = newPoints;
      } else {
        window.ff_all_points = (window.ff_all_points || []).concat(newPoints);
      }

      // Only redraw markers if the map is visible in your mode
      if (typeof isMapVisible === 'function' ? isMapVisible() : true) {
        renderMarkers(window.ff_all_points);
        if (map) map.invalidateSize();
      }
    });


    // --- view control
    function isMapVisible() { return !mapPane.classList.contains('hidden'); }
    function isFiltersVisible() { return !filtersPane.classList.contains('hidden'); }

    function setMode(next) {
      if (next === mode) return;
      mode = next;
      localStorage.setItem('ff_mode', mode);
      applyMode(true);
    }

    function selectButton(active) {
      [btnFilters, btnMap, btnBoth].forEach(btn => {
        btn.classList.remove('bg-slate-900','text-white');
        if (btn.dataset.mode === active) btn.classList.add('bg-slate-900','text-white');
      });
    }

    function applyMode(animated=false) {
      selectButton(mode);

      const hide = (el) => {
        if (!animated) { el.classList.add('hidden','opacity-0'); return; }
        el.classList.add('opacity-0');
        setTimeout(() => el.classList.add('hidden'), 300);
      };
      const show = (el) => {
        el.classList.remove('hidden');
        requestAnimationFrame(() => el.classList.remove('opacity-0'));
      };

      if (mode === 'filters') {
        // show filters; hide map
        show(filtersPane);
        hide(mapPane);
      } else if (mode === 'map') {
        // init & show map; hide filters
        initMapOnce();
        show(mapPane);
        hide(filtersPane);
        setTimeout(() => { if (map) map.invalidateSize(); }, 320);
      } else { // both
        // init & show both
        initMapOnce();
        show(filtersPane);
        show(mapPane);
        setTimeout(() => { if (map) map.invalidateSize(); }, 200);
      }

      // ensure user ring is drawn when map is visible
      if (mode !== 'filters') {
        const r = Number(document.querySelector('[name="radius_km"]').value || 0);
        const la = parseFloat(latInput.value), lo = parseFloat(lngInput.value);
        if (!Number.isNaN(la) && !Number.isNaN(lo)) setUserLocation(la, lo, r);
      }
    }

    function ensureMapVisibleForFocus() {
      // If you have modes, reveal the map (prefer 'both' if you added it)
      if (typeof isMapVisible === 'function' && !isMapVisible()) {
        if (typeof setMode === 'function') setMode('both');
      }
      initMapOnce();
    }

    function highlightResultRow(id) {
      document.querySelectorAll('.result-row').forEach(el => {
        el.classList.remove('ring', 'ring-sky-500', 'bg-sky-50');
      });
      const el = document.querySelector(`.result-row[data-id="${id}"]`);
      if (el) el.classList.add('ring', 'ring-sky-500', 'bg-sky-50');
    }

    function focusPlaceById(id, fallbackLat, fallbackLng) {
      ensureMapVisibleForFocus();

      const m = window.ff_marker_by_id[String(id)];
      if (m) {
        const ll = m.getLatLng();
        //map.flyTo(ll, 16, { duration: 0.5 });
        map.panTo(11);
        m.openPopup();
        highlightResultRow(String(id));
        return;
      }
      // No marker yet? Use the fallback coords (from data attributes)
      if (fallbackLat != null && fallbackLng != null) {
        const ll = L.latLng(fallbackLat, fallbackLng);
        map.flyTo(ll, 16, { duration: 0.5 });
        highlightResultRow(String(id));
      }
    }
    window.focusPlaceById = focusPlaceById; // (optional) expose for debugging

    // Delegate clicks from the result list
    const resultsEl = document.getElementById('results');

    resultsEl.addEventListener('click', (e) => {
      const row = e.target.closest('.result-row');
      if (!row) return;
      const id = row.dataset.id;
      const lat = parseFloat(row.dataset.lat);
      const lng = parseFloat(row.dataset.lng);
      focusPlaceById(id, lat, lng);
    });

    resultsEl.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter' && e.key !== ' ') return;
      const row = e.target.closest('.result-row');
      if (!row) return;
      e.preventDefault();
      const id = row.dataset.id;
      const lat = parseFloat(row.dataset.lat);
      const lng = parseFloat(row.dataset.lng);
      focusPlaceById(id, lat, lng);
    });



    // wire buttons
    btnFilters.addEventListener('click', () => setMode('filters'));
    btnMap.addEventListener('click', () => setMode('map'));
    btnBoth.addEventListener('click', () => setMode('both'));

    // initial mode (default to BOTH)
    window.addEventListener('DOMContentLoaded', () => {
      if (!['filters','map','both'].includes(mode)) mode = 'both';
      applyMode(false);
      // ensure map tiles layout correctly on first paint when visible
      if (mode !== 'filters') setTimeout(() => { if (map) map.invalidateSize(); }, 250);
    });

    // live radius ring update
    document.addEventListener('change', (e) => {
      if (e.target && e.target.name === 'radius_km' && isMapVisible() && userMarker) {
        const r = Number(e.target.value || 0);
        setUserLocation(userMarker.getLatLng().lat, userMarker.getLatLng().lng, r);
      }
    });
  </script>
{% endblock %}
