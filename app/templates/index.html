{% extends "base.html" %}
{% block content %}
  <h1 class="text-xl font-semibold p-3">Fork & Filter</h1>

  <form id="filters"
        class="space-y-3 p-3"
        hx-get="/search" hx-target="#results" hx-swap="outerHTML"
        hx-trigger="load, change delay:200ms">
    <input type="hidden" name="lat" id="lat" value="32.7767">
    <input type="hidden" name="lng" id="lng" value="-96.7970">

    <label class="block">Radius (km)
      <input class="border p-2 rounded w-full" type="number" step="0.1" name="radius_km" value="8">
    </label>

    <label class="block">Menu terms (comma-separated)
      <input class="border p-2 rounded w-full" type="text" name="terms" placeholder="shawarma,tacos">
    </label>

    <label class="block">Prices
      <select class="border p-2 rounded w-full" name="prices" multiple>
        <option value="1">$</option>
        <option value="2">$$</option>
        <option value="3">$$$</option>
      </select>
    </label>

    <label class="inline-flex items-center gap-2">
      <input type="checkbox" name="halal" value="true"> Halal only
    </label>

    <label class="block">Busyness
      <select class="border p-2 rounded w-full" name="busy" multiple>
        <option>Low</option><option>Moderate</option><option>High</option>
      </select>
    </label>

    <button type="button" id="use-location" class="px-3 py-2 bg-sky-600 text-white rounded">
      Use my location
    </button>
  </form>

  <div id="map" class="h-80 m-3 rounded"></div>
  <div id="results" class="m-3"></div>

<script>
(() => {
  // --- shared state across reloads
  window.__ff = window.__ff || {};
  let map = window.__ff.map || null;
  let pins = [];
  let userMarker = window.__ff.userMarker || null;
  let radiusCircle = window.__ff.radiusCircle || null;

  // DOM refs
  const filtersForm = document.getElementById('filters');
  const latInput    = document.getElementById('lat');
  const lngInput    = document.getElementById('lng');
  const radiusInput = document.querySelector('[name="radius_km"]');

  function initMapOnce() {
    if (map) return;
    map = L.map('map').setView([32.7767, -96.7970], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    window.__ff.map = map;
  }

  function setUserLocation(lat, lng, radiusKm) {
    initMapOnce();
    if (userMarker) userMarker.remove();
    if (radiusCircle) radiusCircle.remove();

    userMarker = L.marker([lat, lng], { title: "You are here" }).addTo(map);
    if (radiusKm && radiusKm > 0) {
      radiusCircle = L.circle([lat, lng], { radius: radiusKm * 1000 }).addTo(map);
    }
    window.__ff.userMarker = userMarker;
    window.__ff.radiusCircle = radiusCircle;
  }

  function renderMarkers(points) {
    initMapOnce();
    pins.forEach(m => m.remove()); pins = [];

    const layers = [];
    if (points && points.length) {
      points.forEach(p => {
        const dollars = '$'.repeat(p.price || 0);
        const m = L.marker([p.lat, p.lng]).addTo(map)
          .bindPopup(`${p.name}<br>${p.distance_km} km | ${dollars} | ${p.busy}`);
        pins.push(m); layers.push(m);
      });
    }
    if (window.__ff.userMarker)  layers.push(window.__ff.userMarker);
    if (window.__ff.radiusCircle) layers.push(window.__ff.radiusCircle);

    if (layers.length) {
      const fg = L.featureGroup(layers);
      map.fitBounds(fg.getBounds().pad(0.2));
    } else {
      map.invalidateSize();
    }
  }

  // lifecycle
  window.addEventListener('DOMContentLoaded', () => {
    initMapOnce();
    const saved = localStorage.getItem('ff_loc');
    if (saved) {
      const { lat: la, lng: lo } = JSON.parse(saved);
      if (la && lo) {
        latInput.value = la; lngInput.value = lo;
        setUserLocation(Number(la), Number(lo), Number(radiusInput.value || 0));
      }
    }
  });
  window.addEventListener('pageshow', () => { if (map) map.invalidateSize(); });
  document.body.addEventListener('htmx:afterSettle', () => { if (map) map.invalidateSize(); });

  // AFTER SWAP: read markers from data-attribute (HTMX-safe)
  document.body.addEventListener('htmx:afterSwap', (e) => {
    if (e.target.id !== 'results') return;
    const raw = e.target.getAttribute('data-markers') || "[]";
    const points = JSON.parse(raw);
    renderMarkers(points);
});

  // geolocation
  document.getElementById('use-location').onclick = () => {
    if (!navigator.geolocation) return alert("Geolocation not supported");
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      latInput.value = latitude.toFixed(6);
      lngInput.value = longitude.toFixed(6);
      setUserLocation(latitude, longitude, Number(radiusInput.value || 0));
      filtersForm.dispatchEvent(new Event('change', { bubbles: true }));
      localStorage.setItem('ff_loc', JSON.stringify({ lat: latitude, lng: longitude }));
    }, () => alert("Couldn't get your location"));
  };

  // radius updates ring
  radiusInput.addEventListener('change', () => {
    if (!window.__ff.userMarker) return;
    const r = Number(radiusInput.value || 0);
    const { lat, lng } = window.__ff.userMarker.getLatLng();
    setUserLocation(lat, lng, r);
  });

  document.body.addEventListener('toast', (e) => {
    const msg = typeof e.detail === 'string' ? e.detail : (e.detail?.message || 'Done');
    alert(msg);
  });
  
})();
</script>
<style>#map{height:320px}</style>



{% endblock %}